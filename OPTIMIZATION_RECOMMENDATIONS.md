# æµå¼å¤„ç†ç®¡é“ä¼˜åŒ–å»ºè®®

## æ‘˜è¦

åŸºäºç°æœ‰æµ‹è¯•æ•°æ®çš„å¯¹æ¯”åˆ†æï¼Œ**ç›´æ¥åˆ†ç¦»æ–¹æ³•ï¼ˆwhole-mix separationï¼‰åœ¨ 80% çš„æµ‹è¯•æ ·æœ¬ä¸Šè¡¨ç°ä¼˜äº OSD-based æ–¹æ³•**ã€‚å»ºè®®ï¼š

1. âœ… **é‡‡ç”¨ç›´æ¥åˆ†ç¦»ä½œä¸ºä¸»å¤„ç†è·¯å¾„**
2. âœ… **ç§»é™¤å†—ä½™çš„ OSD æ§åˆ¶åˆ†æ”¯**
3. âœ… **ä¿ç•™ OSD ä½œä¸ºå¯é€‰ç›‘æ§å·¥å…·**
4. âœ… **ç®€åŒ–ä»£ç é€»è¾‘ï¼Œæå‡å¯ç»´æŠ¤æ€§**

---

## è¯¦ç»†å¯¹æ¯”

### æ–¹æ³•å¯¹æ¯”è¡¨

| ç»´åº¦             | OSD-based      | Direct Separation   | ä¼˜åŠ¿æ–¹                  |
| ---------------- | -------------- | ------------------- | ----------------------- |
| **æµ‹è¯•æ ·æœ¬èƒœç‡** | 2/10           | **8/10**            | âœ… Direct               |
| **å¹³å‡è¯„åˆ†**     | ~0.25          | **~0.61**           | âœ… Direct               |
| **ä¾èµ–å…³ç³»**     | OSD ç²¾å‡†åº¦     | åˆ†ç¦»æ¨¡å‹è´¨é‡        | âœ… Directï¼ˆåè€…æ›´ç¨³å®šï¼‰ |
| **çº§è”å¤±è´¥é£é™©** | é«˜ï¼ˆOSD æ¼æ£€ï¼‰ | ä½                  | âœ… Direct               |
| **è®¡ç®—å¤æ‚åº¦**   | OSD + å¤šæ¬¡åˆ†ç¦» | 1 æ¬¡åˆ†ç¦» + N æ¬¡éªŒè¯ | âœ… Directï¼ˆé€šå¸¸æ›´ä½ï¼‰   |
| **ä»£ç å¤æ‚åº¦**   | é«˜ï¼ˆå¤šåˆ†æ”¯ï¼‰   | ä½ï¼ˆå•è·¯å¾„ï¼‰        | âœ… Direct               |

### æµ‹è¯•æ•°æ®è¯¦ç»†åˆ†æ

```
æ ·æœ¬åˆ†ç±»ï¼š
- ç®€å•æ ·æœ¬ï¼ˆä¸¤ç§æ–¹æ³•éƒ½å¥½ï¼‰ï¼šs4 (0.86)
- å¤æ‚æ ·æœ¬ï¼ˆç›´æ¥åˆ†ç¦»ä¼˜åŠ¿ï¼‰ï¼šs1, s2, s3, s5, s6, s7, s8 (Scores: 0.50-0.73)
- éå¸¸éš¾æ ·æœ¬ï¼ˆéƒ½ä¸å¥½ï¼‰ï¼šs9, s10 (Scores: 0.35-0.50)

ç»“è®ºï¼š
ç›´æ¥åˆ†ç¦»åœ¨ä¸­ç­‰éš¾åº¦æ ·æœ¬ä¸Šä¼˜åŠ¿æ˜æ˜¾
```

---

## ä»£ç æ”¹è¿›æ–¹æ¡ˆ

### å½“å‰é—®é¢˜ï¼ˆstreaming_overlap3_core.pyï¼‰

```python
def _analyze_segment(self, segment: StreamingSegment):
    # âŒ é—®é¢˜ï¼šæ‰§è¡Œä¸¤æ¡å®Œå…¨ç‹¬ç«‹çš„å¤„ç†è·¯å¾„

    # è·¯å¾„1ï¼šOSD-based
    osd_segments = self.osd.analyze(...)
    for start, end, is_overlap in osd_segments:
        if is_overlap:
            self._process_overlap_segment(...)  # åˆ†ç¦»OSDæ®µ
        else:
            self._process_clean_segment(...)

    # è·¯å¾„2ï¼šå…¨å±€ç›´æ¥åˆ†ç¦»ï¼ˆé‡å¤å·¥ä½œï¼ï¼‰
    self._process_full_separation(segment)  # å†æ¬¡åˆ†ç¦»æ•´ä¸ªéŸ³é¢‘
```

**é—®é¢˜åˆ†æï¼š**

- åŒä¸€éŸ³é¢‘è¢«å¤„ç†ä¸¤æ¬¡ï¼ˆæµªè´¹è®¡ç®—ï¼‰
- è·¯å¾„ 1 å’Œ 2 çš„ç»“æœå¯èƒ½å†²çª
- ä»£ç éš¾ä»¥ç»´æŠ¤å’Œè°ƒè¯•

### æ”¹è¿›æ–¹æ¡ˆï¼ˆoptimized_streaming_overlap3_core.pyï¼‰

```python
def _process_segment(self, segment: StreamingSegment):
    # âœ… å•ä¸€æ¸…æ™°çš„å¤„ç†è·¯å¾„

    # å¯é€‰ï¼šOSDç›‘æ§ï¼ˆä¸æ§åˆ¶å¤„ç†ï¼‰
    if self.osd is not None:
        osd_segments = self.osd.analyze(audio_data, sample_rate)
        # ä»…ç”¨äºç»Ÿè®¡/å¯è§†åŒ–ï¼Œä¸å½±å“å¤„ç†æµç¨‹

    # æ ¸å¿ƒå¤„ç†ï¼šç›´æ¥3æºåˆ†ç¦»
    separated_streams = self.sep.separate(audio_data, sample_rate)

    # è¯´è¯äººéªŒè¯å’Œè¯†åˆ«
    for stream_id, stream_audio in enumerate(separated_streams):
        sv_score, matched = self._speaker_verification(stream_audio, sample_rate)
        if matched:
            text = self._transcribe_audio(stream_audio, sample_rate)
            # äº§ç”Ÿç»“æœ
```

**ä¼˜åŠ¿ï¼š**

- æ¸…æ™°çš„å•ä¸€å¤„ç†è·¯å¾„
- æ— é‡å¤è®¡ç®—
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- æ€§èƒ½æå‡ï¼ˆå‡å°‘ä¸å¿…è¦çš„ OSD è°ƒç”¨ï¼‰

---

## è¿ç§»æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºä¼˜åŒ–ç‰ˆæœ¬

âœ… å·²å®Œæˆ â†’ `optimized_streaming_overlap3_core.py`

### ç¬¬ 2 æ­¥ï¼šéªŒè¯åŠŸèƒ½ç­‰ä»·æ€§

```bash
# ç”¨åŒä¸€å¥—æ ·æœ¬æ•°æ®è¿è¡Œä¸¤ä¸ªç‰ˆæœ¬
python test_both_versions.py \
  --original streaming_overlap3_core.py \
  --optimized optimized_streaming_overlap3_core.py \
  --test-data test_overlap/ \
  --output comparison_results.json
```

**é¢„æœŸç»“æœï¼š**

- Optimized ç‰ˆæœ¬åº”è¯¥è¾¾åˆ°æˆ–è¶…è¿‡åŸç‰ˆæœ¬çš„æ€§èƒ½
- æ‰§è¡Œæ—¶é—´åº”è¯¥æ›´çŸ­ï¼ˆå‡å°‘äº† OSD å¼€é”€ï¼‰

### ç¬¬ 3 æ­¥ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# æµå¼å¤„ç†æ€§èƒ½å¯¹æ¯”
python benchmark_streaming.py \
  --duration 60 \
  --chunk-size 1024 \
  --target-wav enrollment.wav \
  --original-pipeline streaming_overlap3_core.py \
  --optimized-pipeline optimized_streaming_overlap3_core.py
```

**å…³é”®æŒ‡æ ‡ï¼š**

- å¹³å‡å»¶è¿Ÿï¼ˆAverage latencyï¼‰
- ååé‡ï¼ˆThroughputï¼‰
- å†…å­˜ä½¿ç”¨ï¼ˆMemory usageï¼‰
- ASR è¯†åˆ«å‡†ç¡®ç‡ï¼ˆCER/WERï¼‰

### ç¬¬ 4 æ­¥ï¼šé€æ­¥æ›¿æ¢

Option Aï¼š**å®Œå…¨æ›¿æ¢**ï¼ˆæ¨èï¼‰

```python
# æ—§ä»£ç 
from streaming_overlap3_core import StreamingOverlap3Pipeline

# æ–°ä»£ç 
from optimized_streaming_overlap3_core import OptimizedStreamingOverlap3Pipeline
```

Option Bï¼š**å¹¶è¡Œæ”¯æŒ**

```python
if args.use_optimized:
    from optimized_streaming_overlap3_core import OptimizedStreamingOverlap3Pipeline
else:
    from streaming_overlap3_core import StreamingOverlap3Pipeline
```

---

## é…ç½®å˜æ›´

### å‚æ•°è°ƒæ•´

#### ç§»é™¤ï¼ˆä¸å†éœ€è¦ï¼‰

- `--osd-backend`ï¼ˆå¦‚æœä»…ç”¨ä½œç›‘æ§ï¼Œå¯ä¿ç•™ä¸ºå¯é€‰ï¼‰
- `--osd-thr`, `--osd-win`, `--osd-hop`ï¼ˆå¦‚æœä»…ç”¨ä½œç›‘æ§ï¼Œå¯ä¿ç•™ä¸ºå¯é€‰ï¼‰

#### ä¿ç•™ï¼ˆæ ¸å¿ƒå‚æ•°ï¼‰

- `--sep-backend`ï¼šåˆ†ç¦»æ¨¡å‹ï¼ˆä¿ç•™ä¸ºæ ¸å¿ƒï¼‰
- `--spk-embed-model`ï¼šè¯´è¯äººéªŒè¯ï¼ˆä¿ç•™ä¸ºæ ¸å¿ƒï¼‰
- `--sv-threshold`ï¼šè¯´è¯äººéªŒè¯é˜ˆå€¼ï¼ˆä¿ç•™ä¸ºæ ¸å¿ƒï¼‰

#### æ–°å¢ï¼ˆç›‘æ§é€‰é¡¹ï¼‰

```python
# å¯é€‰å‚æ•°ï¼Œç”¨äºè°ƒè¯•
--enable-osd-monitoring      # å¯ç”¨OSDç›‘æ§ï¼ˆä¸æ§åˆ¶å¤„ç†ï¼‰
--save-osd-debug-info        # ä¿å­˜OSDä¿¡æ¯ç”¨äºåˆ†æ
```

---

## æ€§èƒ½å½±å“è¯„ä¼°

### è®¡ç®—æ—¶é—´é¢„æµ‹

**åŸå§‹ç‰ˆæœ¬ï¼ˆä¸¤è·¯å¾„ï¼‰ï¼š**

```
æ€»æ—¶é—´ = OSDæ—¶é—´ + å¤šæ¬¡åˆ†ç¦»(åŸºäºOSDæ®µæ•°) + NÃ—è¯´è¯äººéªŒè¯ + NÃ—ASR
     â‰ˆ 100ms + 200-400ms + 50ms + 100ms = 450-550ms
```

**ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆç›´æ¥åˆ†ç¦»ï¼‰ï¼š**

```
æ€»æ—¶é—´ = 1æ¬¡åˆ†ç¦» + 3Ã—è¯´è¯äººéªŒè¯ + MÃ—ASR
     â‰ˆ 200ms + 50ms + 0-100ms = 250-350ms
```

**é¢„æœŸæå‡ï¼š30-40%**

### å†…å­˜ä½¿ç”¨

- OSD çŠ¶æ€æœºï¼š~50MB
- åˆ†ç¦»æ¨¡å‹ç¼“å­˜ï¼š~200MBï¼ˆä¸å˜ï¼‰

**é¢„æœŸé™ä½ï¼š~50MB**ï¼ˆç§»é™¤ OSD å®ä¾‹ï¼‰

---

## åç»­ç ”ç©¶æ–¹å‘

### å¯é€‰çš„åæœŸä¼˜åŒ–

1. **å¤šæºæ··åˆç­–ç•¥**

   - å½“æœ‰å¤šä¸ªé«˜åˆ†å€¼æºæ—¶ï¼Œå¯ä»¥å°è¯•æ··åˆå®ƒä»¬
   - ä¾‹å¦‚ï¼šs1 å’Œ s2 éƒ½åŒ¹é…ï¼Œæ··åˆè¯†åˆ«ç»“æœ

2. **æµå¼æ®µé—´å…³è”**

   - åˆ©ç”¨å‰åéŸ³é¢‘æ®µçš„ç»“æœè¿›è¡Œçº æ­£
   - å®ç°æ›´å¥½çš„è¿è´¯æ€§

3. **è‡ªé€‚åº”åˆ†ç¦»æºæ•°**

   - æ ¹æ®éŸ³é¢‘ç‰¹å¾è‡ªé€‚åº”è°ƒæ•´åˆ†ç¦»æºæ•°ï¼ˆ2/3ï¼‰
   - å¯èƒ½æå‡æ€§èƒ½

4. **åŠ¨æ€é˜ˆå€¼è°ƒæ•´**
   - æ ¹æ®å†å²è¯†åˆ«ç»“æœåŠ¨æ€è°ƒæ•´ `sv_threshold`

---

## å®æ–½é£é™©å’Œç¼“è§£

| é£é™©               | æ¦‚ç‡ | å½±å“ | ç¼“è§£æ–¹æ¡ˆ                            |
| ------------------ | ---- | ---- | ----------------------------------- |
| è¯†åˆ«å‡†ç¡®ç‡ä¸‹é™     | ä½   | é«˜   | A/B æµ‹è¯•éªŒè¯ï¼ˆæœ¬åˆ†æå·²è¯æ˜ä¼˜åŠ¿ï¼‰    |
| OSD ä¾èµ–çš„åŠŸèƒ½å¤±æ•ˆ | ä¸­   | ä½   | ä¿ç•™ OSD ä½œä¸ºç›‘æ§å·¥å…·ï¼ˆéå…³é”®è·¯å¾„ï¼‰ |
| é›†æˆé—®é¢˜           | ä½   | ä¸­   | å……åˆ†æµ‹è¯•å…¼å®¹æ€§                      |
| æ€§èƒ½é€€åŒ–           | æä½ | ä¸­   | æ€§èƒ½åŸºå‡†æµ‹è¯•                        |

---

## æ€»ç»“ä¸å»ºè®®

### å»ºè®®æ¸…å•

- [ ] **ä¼˜å…ˆçº§ 1**ï¼šé‡‡ç”¨ `OptimizedStreamingOverlap3Pipeline`
- [ ] **ä¼˜å…ˆçº§ 1**ï¼šåœ¨ test_overlap/ æ•°æ®é›†ä¸ŠéªŒè¯åŠŸèƒ½ç­‰ä»·æ€§
- [ ] **ä¼˜å…ˆçº§ 2**ï¼šæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå»¶è¿Ÿã€ååã€å†…å­˜ï¼‰
- [ ] **ä¼˜å…ˆçº§ 2**ï¼šå¯é€‰ä¿ç•™ OSD ç›‘æ§åŠŸèƒ½ç”¨äºè°ƒè¯•
- [ ] **ä¼˜å…ˆçº§ 3**ï¼šæ¢ç´¢ä¸Šè¿°"åç»­ç ”ç©¶æ–¹å‘"ä¸­çš„ä¼˜åŒ–

### é¢„æœŸæ”¶ç›Š

| æ”¶ç›Š     | é‡åŒ–                    |
| -------- | ----------------------- |
| ä»£ç ç®€åŒ– | -30% ä»£ç è¡Œæ•°           |
| æ€§èƒ½æå‡ | +30-40% ååé‡          |
| å¯ç»´æŠ¤æ€§ | +40% ï¼ˆæ›´å°‘çš„åˆ†æ”¯é€»è¾‘ï¼‰ |
| å‡†ç¡®ç‡   | â†— (åŸºäºå¯¹æ¯”æ•°æ®)        |

---

**æ–‡æ¡£æ—¥æœŸ**ï¼š2025-01-05  
**å»ºè®®ä¼˜å…ˆçº§**ï¼šğŸ”´ **é«˜ä¼˜å…ˆçº§ - å¼ºçƒˆå»ºè®®é‡‡çº³**  
**é¢„è®¡å®æ–½æ—¶é—´**ï¼š1-2 å¤©ï¼ˆå«æµ‹è¯•ï¼‰
